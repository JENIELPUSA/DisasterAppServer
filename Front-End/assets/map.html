<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <style>
      body, html {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      }
      #map {
        width: 100%;
        height: 100%;
      }
      .legend {
        position: absolute;
        top: 80px;
        right: 10px;
        background: white;
        padding: 12px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.12);
        z-index: 1000;
        font-size: 12px;
        border: 1px solid #e5e7eb;
        max-width: 180px;
        line-height: 1.4;
        backdrop-filter: blur(10px);
        background: rgba(255, 255, 255, 0.98);
      }
      .legend-header {
        font-weight: 700;
        margin-bottom: 10px;
        padding-bottom: 6px;
        border-bottom: 1px solid #e5e7eb;
        color: #111827;
        font-size: 13px;
        display: flex;
        align-items: center;
        gap: 6px;
      }
      .legend-items {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .legend-item {
        display: flex;
        align-items: center;
        padding: 4px 0;
      }
      .legend-icon {
        width: 22px;
        height: 22px;
        border-radius: 50%;
        margin-right: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 10px;
        color: white;
        font-weight: bold;
        border: 2px solid white;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      }
      .legend-text {
        color: #374151;
        font-size: 11px;
        flex: 1;
        font-weight: 500;
      }
      .legend-count {
        background: #f3f4f6;
        padding: 1px 6px;
        border-radius: 10px;
        font-size: 10px;
        font-weight: 700;
        color: #4b5563;
        margin-left: 4px;
        min-width: 20px;
        text-align: center;
      }
      
      /* =================== */
      /* IMPROVED MUNICIPALITY MARKER STYLES */
      /* =================== */
      .municipality-boundary-marker {
        transition: all 0.3s ease;
      }
      
      .municipality-pin {
        width: 100%;
        height: 100%;
        border-radius: 50% 50% 50% 0;
        background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
        transform: rotate(-45deg);
        position: relative;
        box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        transition: all 0.2s ease;
      }
      
      .municipality-pin:after {
        content: '';
        width: 40%;
        height: 40%;
        margin: 30%;
        border-radius: 50%;
        background: white;
        position: absolute;
      }
      
      /* Evacuation icons (remain as icons) */
      .evacuation-full {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      }
      
      .evacuation-high {
        background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
      }
      
      .evacuation-available {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      }
      
      .evacuation-unknown {
        background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
      }
      
      /* Household icons (remain as icons) */
      .household-icon {
        width: 32px;
        height: 32px;
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 14px;
        border: 2px solid white;
        box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        position: relative;
        transition: all 0.2s ease;
      }
      
      .household-active {
        background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
      }
      
      .household-inactive {
        background: linear-gradient(135deg, #a78bfa 0%, #8b5cf6 100%);
      }
      
      .household-icon:hover {
        transform: scale(1.1);
        box-shadow: 0 3px 8px rgba(0,0,0,0.25);
        z-index: 1000 !important;
      }
      
      /* =================== */
      /* NEW MODERN TOOLTIP/POPUP STYLES */
      /* =================== */
      .modern-popup {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        font-size: 11px;
        min-width: 200px;
        max-width: 240px;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
        border: 1px solid #e5e7eb;
        background: white;
      }
      
      .popup-header {
        background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
        color: white;
        padding: 14px 16px;
        margin: 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: relative;
      }
      
      .popup-header:after {
        content: '';
        position: absolute;
        bottom: -8px;
        left: 20px;
        width: 16px;
        height: 16px;
        background: white;
        transform: rotate(45deg);
        border-right: 1px solid #e5e7eb;
        border-bottom: 1px solid #e5e7eb;
      }
      
      .popup-title {
        font-size: 14px;
        font-weight: 700;
        flex: 1;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      
      .popup-status {
        background: rgba(255,255,255,0.25);
        padding: 3px 10px;
        border-radius: 20px;
        font-size: 9px;
        font-weight: 700;
        letter-spacing: 0.5px;
        text-transform: uppercase;
        border: 1px solid rgba(255,255,255,0.3);
      }
      
      .popup-content {
        padding: 16px;
        background: white;
        position: relative;
        z-index: 1;
      }
      
      /* NEW: Lead Info Section */
      .lead-info-section {
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        border-radius: 10px;
        padding: 14px;
        margin-bottom: 16px;
        border: 1px solid #e2e8f0;
        position: relative;
      }
      
      .lead-avatar {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 10px auto;
        color: white;
        font-size: 18px;
        border: 3px solid white;
        box-shadow: 0 4px 8px rgba(139, 92, 246, 0.2);
      }
      
      .lead-name {
        font-size: 15px;
        font-weight: 700;
        color: #111827;
        text-align: center;
        margin-bottom: 6px;
        line-height: 1.3;
      }
      
      .household-badge {
        display: inline-block;
        background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%);
        color: #4f46e5;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 11px;
        font-weight: 700;
        letter-spacing: 0.5px;
        margin: 0 auto;
        text-align: center;
        border: 1px solid #c7d2fe;
      }
      
      /* NEW: Quick Stats */
      .quick-stats {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 8px;
        margin: 14px 0;
      }
      
      .quick-stat {
        background: white;
        border-radius: 8px;
        padding: 10px;
        text-align: center;
        border: 1px solid #e5e7eb;
        transition: all 0.2s ease;
      }
      
      .quick-stat:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      }
      
      .quick-stat-icon {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 6px auto;
        color: #6b7280;
        font-size: 10px;
      }
      
      .quick-stat-value {
        font-weight: 800;
        font-size: 13px;
        color: #111827;
        margin-bottom: 2px;
      }
      
      .quick-stat-label {
        font-size: 9px;
        color: #6b7280;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      
      /* NEW: Coordinates with Zoom Info */
      .coordinates-section {
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        border-radius: 10px;
        padding: 12px;
        margin: 14px 0;
        border: 1px solid #e2e8f0;
      }
      
      .coordinates-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
        margin-bottom: 10px;
      }
      
      .coordinate-item {
        background: white;
        border-radius: 6px;
        padding: 8px;
        text-align: center;
      }
      
      .coordinate-label {
        font-size: 9px;
        color: #6b7280;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 4px;
      }
      
      .coordinate-value {
        font-family: 'SF Mono', Monaco, 'Courier New', monospace;
        font-size: 10px;
        font-weight: 600;
        color: #111827;
      }
      
      /* NEW: Zoom Level Display */
      .zoom-info {
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: white;
        border-radius: 6px;
        padding: 8px 12px;
        margin-top: 10px;
        border: 1px solid #e5e7eb;
      }
      
      .zoom-label {
        font-size: 9px;
        color: #6b7280;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        display: flex;
        align-items: center;
        gap: 4px;
      }
      
      .zoom-value {
        font-family: 'SF Mono', Monaco, 'Courier New', monospace;
        font-size: 11px;
        font-weight: 700;
        color: #8b5cf6;
        background: #f3f4f6;
        padding: 2px 8px;
        border-radius: 4px;
      }
      
      /* NEW: Last Update Time */
      .last-update {
        text-align: center;
        font-size: 9px;
        color: #9ca3af;
        margin-top: 12px;
        padding-top: 8px;
        border-top: 1px solid #f1f5f9;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 4px;
      }
      
      /* NEW: Action Buttons */
      .action-buttons {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
        margin-top: 16px;
      }
      
      .action-btn {
        background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
        color: white;
        border: none;
        padding: 8px 12px;
        border-radius: 8px;
        font-size: 10px;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 4px;
        transition: all 0.2s ease;
      }
      
      .action-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
      }
      
      .action-btn-secondary {
        background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
        color: #4b5563;
      }
      
      /* Layer control */
      .leaflet-control-layers {
        background: rgba(255, 255, 255, 0.98);
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(229, 231, 235, 0.5);
        padding: 8px;
        font-size: 11px;
      }
      
      .leaflet-control-layers-toggle {
        background-color: white;
        border-radius: 6px;
        box-shadow: 0 1px 4px rgba(0,0,0,0.1);
        width: 36px;
        height: 36px;
        background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%233b82f6"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg>');
        background-size: 20px;
        background-position: center;
        background-repeat: no-repeat;
      }
      
      /* Loading overlay */
      .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.95);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 2000;
      }
      
      .loading-spinner {
        width: 50px;
        height: 50px;
        border: 3px solid #e5e7eb;
        border-top: 3px solid #3b82f6;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 15px;
      }
      
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      
      /* Leaflet popup adjustments */
      .leaflet-popup-content-wrapper {
        border-radius: 12px;
        padding: 0;
        overflow: hidden;
      }
      
      .leaflet-popup-tip {
        background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
      }
      
      /* Responsive */
      @media (max-width: 768px) {
        .legend {
          top: 70px;
          right: 8px;
          max-width: 160px;
          font-size: 10px;
          padding: 10px;
        }
        
        .municipality-dot {
          width: 14px;
          height: 14px;
        }
        
        .household-icon {
          width: 28px;
          height: 28px;
          font-size: 12px;
        }
        
        .modern-popup {
          min-width: 180px;
          max-width: 220px;
        }
        
        .popup-header {
          padding: 12px 14px;
        }
        
        .popup-title {
          font-size: 13px;
        }
      }
      
      @media (max-width: 480px) {
        .legend {
          top: 60px;
          right: 6px;
          max-width: 140px;
          font-size: 9px;
          padding: 8px;
        }
        
        .legend-icon {
          width: 18px;
          height: 18px;
          margin-right: 6px;
          font-size: 8px;
        }
        
        .municipality-dot {
          width: 12px;
          height: 12px;
        }
        
        .household-icon {
          width: 24px;
          height: 24px;
          font-size: 10px;
        }
        
        .modern-popup {
          min-width: 170px;
          max-width: 200px;
          font-size: 10px;
        }
        
        .quick-stats {
          grid-template-columns: repeat(3, 1fr);
          gap: 6px;
        }
        
        .quick-stat {
          padding: 8px 6px;
        }
      }
      
      /* NEW: Simple tooltip style for municipalities */
      .municipality-tooltip {
        background: rgba(255, 255, 255, 0.95);
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        padding: 6px 10px;
        font-size: 13px;
        font-weight: 600;
        color: #111827;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        white-space: nowrap;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>
    <div id="legend" class="legend" style="display: none;">
      <div class="legend-header">
        <i class="fas fa-map-signs"></i>
        <span>MAP LEGEND</span>
      </div>
      <div class="legend-items" id="legend-items">
        <!-- Legend items will be dynamically added here -->
      </div>
    </div>

    <script>
      let map;
      let municipalityLayerGroup = L.layerGroup();
      let evacuationLayerGroup = L.layerGroup();
      let householdLayerGroup = L.layerGroup();
      let currentView = "both";
      let lastFocusedHouseholdId = null;
      let iconType = "professional";
      let zoomListeners = [];
      let lastZoomLevel = 13; // Default zoom level
      let lastZoomBeforeClick = 13; // NEW: Store zoom level before clicking any marker
      
      // Create municipality marker na dynamic ang size base sa zoom
      function createMunicipalityMarker(item) {
        if (!item.coordinates?.latitude || !item.coordinates?.longitude) return null;
        
        const lat = item.coordinates.latitude;
        const lng = item.coordinates.longitude;
        
        // Gumawa ng circle marker na dynamic ang size
        const circleMarker = L.circleMarker([lat, lng], {
          radius: 8, // Base radius
          fillColor: '#3b82f6',
          color: '#ffffff',
          weight: 2,
          opacity: 1,
          fillOpacity: 0.8,
          className: 'municipality-boundary-marker'
        });
        
        // Function para i-update ang radius base sa zoom level
        function updateRadius() {
          const zoom = map.getZoom();
          lastZoomLevel = zoom; // Store last zoom
          let radius;
          
          if (zoom >= 15) {
            radius = 10;
          } else if (zoom >= 12) {
            radius = 8;
          } else if (zoom >= 9) {
            radius = 6;
          } else if (zoom >= 6) {
            radius = 4;
          } else {
            radius = 3;
          }
          
          circleMarker.setRadius(radius);
          circleMarker.setStyle({
            weight: zoom >= 12 ? 2 : 1,
            fillOpacity: zoom >= 9 ? 0.8 : 0.9
          });
        }
        
        // Idagdag ang event listener para sa zoom change
        const zoomListener = () => updateRadius();
        map.on('zoomend', zoomListener);
        zoomListeners.push({ marker: circleMarker, listener: zoomListener });
        
        // I-initialize ang radius
        updateRadius();
        
        // Simple tooltip with municipality name only
        const municipalityName = item.municipality || item.barangayName || "Municipality";
        
        // Add tooltip (not popup) for hover
        circleMarker.bindTooltip(municipalityName, {
          permanent: false,
          direction: 'top',
          className: 'municipality-tooltip',
          offset: [0, -10]
        });
        
        // Modern popup content (for click)
        const popupContent = `
          <div class="modern-popup">
            <div class="popup-header">
              <div class="popup-title">
                <i class="fas fa-city"></i>
                ${municipalityName}
              </div>
              <div class="popup-status">GOVT</div>
            </div>
            <div class="popup-content">
              <div class="lead-info-section">
                <div class="lead-avatar">
                  <i class="fas fa-landmark"></i>
                </div>
                <div class="lead-name">
                  ${municipalityName}
                </div>
                ${item.barangayName ? `
                <div class="household-badge">
                  <i class="fas fa-map-pin"></i> ${item.barangayName}
                </div>
                ` : ''}
              </div>
              
              <div class="coordinates-section">
                <div class="coordinates-grid">
                  <div class="coordinate-item">
                    <div class="coordinate-label">Latitude</div>
                    <div class="coordinate-value">${lat.toFixed(6)}</div>
                  </div>
                  <div class="coordinate-item">
                    <div class="coordinate-label">Longitude</div>
                    <div class="coordinate-value">${lng.toFixed(6)}</div>
                  </div>
                </div>
                
                <div class="zoom-info">
                  <div class="zoom-label">
                    <i class="fas fa-search-plus"></i>
                    <span>Current Zoom</span>
                  </div>
                  <div class="zoom-value" id="municipality-zoom-value">${lastZoomLevel}</div>
                </div>
              </div>
              
              ${item.fullAddress ? `
              <div class="quick-stat" style="text-align: left; padding: 10px; margin: 12px 0;">
                <div class="quick-stat-icon" style="margin: 0 0 6px 0;">
                  <i class="fas fa-map-marker-alt"></i>
                </div>
                <div style="font-size: 10px; color: #6b7280; margin-bottom: 4px;">Address</div>
                <div style="font-size: 11px; color: #111827; line-height: 1.4;">${item.fullAddress.substring(0, 60)}${item.fullAddress.length > 60 ? '...' : ''}</div>
              </div>
              ` : ''}
              
              <div class="last-update">
                <i class="far fa-clock"></i>
                <span>Last updated: Just now</span>
              </div>
            </div>
          </div>
        `;
        
        circleMarker.bindPopup(popupContent, { maxWidth: 280, className: 'modern-popup' });
        
        circleMarker.on('click', function() {
          lastZoomBeforeClick = map.getZoom(); // Store zoom before zooming
          map.setView([lat, lng], 14, { animate: true, duration: 1 });
        });
        
        circleMarker.on('mouseover', function() {
          this.setStyle({
            fillColor: '#1d4ed8',
            fillOpacity: 0.9,
            weight: 3
          });
        });
        
        circleMarker.on('mouseout', function() {
          const zoom = map.getZoom();
          this.setStyle({
            fillColor: '#3b82f6',
            fillOpacity: zoom >= 9 ? 0.8 : 0.9,
            weight: zoom >= 12 ? 2 : 1
          });
        });
        
        return circleMarker;
      }
      
      // Create evacuation icon
      function createEvacuationIcon(status = '') {
        let className = '';
        const statusLower = status.toLowerCase();
        
        if (statusLower === 'full') {
          className = 'evacuation-full';
        } else if (statusLower === 'high') {
          className = 'evacuation-high';
        } else if (statusLower === 'available') {
          className = 'evacuation-available';
        } else {
          className = 'evacuation-unknown';
        }
        
        return L.divIcon({
          className: `professional-icon ${className}`,
          html: `<i class="fas fa-first-aid"></i>`,
          iconSize: [32, 32],
          iconAnchor: [16, 32],
          popupAnchor: [0, -32]
        });
      }
      
      // Create household icon
      function createHouseholdIcon(isActive = true) {
        const className = isActive ? 'household-active' : 'household-inactive';
        
        return L.divIcon({
          className: `household-icon ${className}`,
          html: `<i class="fas fa-home"></i>`,
          iconSize: [32, 32],
          iconAnchor: [16, 32],
          popupAnchor: [0, -32]
        });
      }
      
      // Format date
      function formatDate(dateString) {
        if (!dateString) return 'N/A';
        const date = new Date(dateString);
        return date.toLocaleDateString('en-PH', {
          year: 'numeric',
          month: 'short',
          day: 'numeric'
        });
      }
      
      // Calculate age from birthdate
      function calculateAge(birthDate) {
        if (!birthDate) return 'N/A';
        const birth = new Date(birthDate);
        const today = new Date();
        let age = today.getFullYear() - birth.getFullYear();
        const m = today.getMonth() - birth.getMonth();
        if (m < 0 || (m === 0 && today.getDate() < birth.getDate())) {
          age--;
        }
        return age;
      }
      
      // Add municipality markers - IMPROVED VERSION
      function addMunicipalityMarkers(municipalities) {
        // Clear previous zoom listeners
        zoomListeners.forEach(({ marker, listener }) => {
          if (map && marker && listener) {
            map.off('zoomend', listener);
          }
        });
        zoomListeners = [];
        
        municipalityLayerGroup.clearLayers();
        
        municipalities.forEach((item) => {
          const marker = createMunicipalityMarker(item);
          if (marker) {
            marker.addTo(municipalityLayerGroup);
          }
        });
      }
      
      // Add evacuation markers with modern popup
      function addEvacuationMarkers(evacuations) {
        evacuationLayerGroup.clearLayers();
        
        evacuations.forEach((item, index) => {
          if (!item.location?.latitude || !item.location?.longitude) return;
          
          const lat = item.location.latitude;
          const lng = item.location.longitude;
          const status = item.status?.toLowerCase() || 'unknown';
          
          const icon = createEvacuationIcon(status);
          const marker = L.marker([lat, lng], { icon: icon });
          
          // Add tooltip for evacuation centers
          const evacuationName = item.evacuationName || "Evacuation Center";
          marker.bindTooltip(evacuationName, {
            permanent: false,
            direction: 'top',
            className: 'municipality-tooltip',
            offset: [0, -10]
          });
          
          let statusColor = '#6b7280';
          let statusText = 'Unknown';
          let statusClass = '';
          
          switch(status) {
            case 'full': 
              statusColor = '#ef4444';
              statusText = 'FULL';
              statusClass = 'danger';
              break;
            case 'high': 
              statusColor = '#f97316';
              statusText = 'HIGH';
              statusClass = 'warning';
              break;
            case 'available': 
              statusColor = '#10b981';
              statusText = 'AVAILABLE';
              statusClass = 'success';
              break;
          }
          
          // Modern evacuation popup
          const popupContent = `
            <div class="modern-popup">
              <div class="popup-header" style="background: linear-gradient(135deg, ${statusColor} 0%, ${statusColor}80 100%);">
                <div class="popup-title">
                  <i class="fas fa-first-aid"></i>
                  ${evacuationName}
                </div>
                <div class="popup-status" style="background: rgba(255,255,255,0.3);">${statusText}</div>
              </div>
              <div class="popup-content">
                <div class="lead-info-section">
                  <div class="lead-avatar" style="background: linear-gradient(135deg, ${statusColor} 0%, ${statusColor}80 100%);">
                    <i class="fas fa-users"></i>
                  </div>
                  <div class="lead-name">
                    ${evacuationName}
                  </div>
                  <div class="household-badge" style="background: linear-gradient(135deg, ${statusColor}20 0%, ${statusColor}10 100%); color: ${statusColor}; border-color: ${statusColor}30;">
                    <i class="fas fa-user-shield"></i> Evacuation Center
                  </div>
                </div>
                
                ${item.evacuationCapacity ? `
                <div class="quick-stats">
                  <div class="quick-stat">
                    <div class="quick-stat-icon">
                      <i class="fas fa-users"></i>
                    </div>
                    <div class="quick-stat-value" style="color: ${statusColor};">${item.currentEvacuation || 0}</div>
                    <div class="quick-stat-label">Current</div>
                  </div>
                  <div class="quick-stat">
                    <div class="quick-stat-icon">
                      <i class="fas fa-user-plus"></i>
                    </div>
                    <div class="quick-stat-value">${item.availableCapacity || 0}</div>
                    <div class="quick-stat-label">Available</div>
                  </div>
                  <div class="quick-stat">
                    <div class="quick-stat-icon">
                      <i class="fas fa-chart-bar"></i>
                    </div>
                    <div class="quick-stat-value">${item.evacuationCapacity}</div>
                    <div class="quick-stat-label">Capacity</div>
                  </div>
                </div>
                ` : ''}
                
                <div class="coordinates-section">
                  <div class="coordinates-grid">
                    <div class="coordinate-item">
                      <div class="coordinate-label">Latitude</div>
                      <div class="coordinate-value">${lat.toFixed(6)}</div>
                    </div>
                    <div class="coordinate-item">
                      <div class="coordinate-label">Longitude</div>
                      <div class="coordinate-value">${lng.toFixed(6)}</div>
                    </div>
                  </div>
                  
                  <div class="zoom-info">
                    <div class="zoom-label">
                      <i class="fas fa-search-plus"></i>
                      <span>Current Zoom</span>
                    </div>
                    <div class="zoom-value" style="color: ${statusColor};">${lastZoomLevel}</div>
                  </div>
                </div>
                
                ${item.contactPerson?.name ? `
                <div class="quick-stat" style="text-align: left; padding: 10px; margin: 12px 0;">
                  <div class="quick-stat-icon" style="margin: 0 0 6px 0;">
                    <i class="fas fa-user-tie"></i>
                  </div>
                  <div style="font-size: 10px; color: #6b7280; margin-bottom: 4px;">Contact Person</div>
                  <div style="font-size: 11px; color: #111827; font-weight: 600;">${item.contactPerson.name}</div>
                  ${item.contactPerson.contactNumber ? `
                  <div style="font-size: 10px; color: ${statusColor}; margin-top: 2px;">
                    <i class="fas fa-phone"></i> ${item.contactPerson.contactNumber}
                  </div>
                  ` : ''}
                </div>
                ` : ''}
                
                <div class="last-update">
                  <i class="far fa-clock"></i>
                  <span>Status: ${statusText}</span>
                </div>
              </div>
            </div>
          `;
          
          marker.bindPopup(popupContent, { maxWidth: 280, className: 'modern-popup' });
          
          marker.on('click', function() {
            lastZoomBeforeClick = map.getZoom(); // Store zoom before zooming
            map.setView([lat, lng], 16, { animate: true, duration: 1 });
          });
          
          marker.addTo(evacuationLayerGroup);
        });
      }
      
      // Add household markers with modern popup - MODIFIED
      function addHouseholdMarkers(households, focusOnId = null) {
        householdLayerGroup.clearLayers();
        
        households.forEach((item, index) => {
          if (!item.location?.latitude || !item.location?.longitude) return;
          
          const lat = item.location.latitude;
          const lng = item.location.longitude;
          const isActive = item.isActive;
          
          const icon = createHouseholdIcon(isActive);
          const marker = L.marker([lat, lng], { 
            icon: icon,
            title: item.userId?.fullName || "Household"
          });
          
          // Add tooltip for households
          let leadName = item.userId?.fullName || "Household";
          if (!leadName || leadName === "N/A") {
            if (item.members && item.members.length > 0) {
              const headMember = item.members.find(m => 
                m.relationship && m.relationship.toLowerCase().includes('head') || 
                m.relationship && m.relationship.toLowerCase().includes('lead')
              );
              if (headMember && headMember.userId?.fullName) {
                leadName = headMember.userId.fullName;
              } else if (item.members[0].userId?.fullName) {
                leadName = item.members[0].userId.fullName;
              }
            }
          }
          
          marker.bindTooltip(leadName, {
            permanent: false,
            direction: 'top',
            className: 'municipality-tooltip',
            offset: [0, -10]
          });
          
          // Create precise pinpoint circle
          const pinpointCircle = L.circleMarker([lat, lng], {
            radius: 3,
            color: isActive ? '#8b5cf6' : '#a78bfa',
            fillColor: isActive ? '#8b5cf6' : '#a78bfa',
            fillOpacity: 0.8,
            weight: 1,
            className: 'precise-location'
          });
          
          const popupContent = createHouseholdPopup(item, lat, lng);
          marker.bindPopup(popupContent, { 
            maxWidth: 240,
            className: 'modern-popup'
          });
          
          // Focus on this household if specified
          if (focusOnId && item._id === focusOnId) {
            lastFocusedHouseholdId = item._id;
            setTimeout(() => {
              // Store zoom before focusing
              lastZoomBeforeClick = map.getZoom();
              map.setView([lat, lng], 18, { animate: true, duration: 1 });
              marker.openPopup();
              pinpointCircle.setStyle({ radius: 6, fillOpacity: 0.3 });
              
              const pulseCircle = L.circle([lat, lng], {
                radius: 20,
                color: isActive ? '#8b5cf6' : '#a78bfa',
                fillColor: isActive ? '#8b5cf6' : '#a78bfa',
                fillOpacity: 0.1,
                weight: 1
              }).addTo(householdLayerGroup);
              
              setTimeout(() => {
                householdLayerGroup.removeLayer(pulseCircle);
                pinpointCircle.setStyle({ radius: 3, fillOpacity: 0.8 });
              }, 2000);
            }, 300);
          }
          
          // Track zoom before marker click
          marker.on('click', function() {
            // Store the current zoom level before zooming in
            lastZoomBeforeClick = map.getZoom();
            map.setView([lat, lng], 18, { animate: true, duration: 1 });
            pinpointCircle.setStyle({ radius: 6, fillOpacity: 0.3 });
            
            setTimeout(() => {
              pinpointCircle.setStyle({ radius: 3, fillOpacity: 0.8 });
            }, 800);
          });
          
          marker.addTo(householdLayerGroup);
          pinpointCircle.addTo(householdLayerGroup);
        });
      }
      
      // Create MODERN household popup with last zoom - MODIFIED
      function createHouseholdPopup(item, lat, lng) {
        const isActive = item.isActive;
        const statusColor = isActive ? '#10b981' : '#6b7280';
        const statusText = isActive ? 'ACTIVE' : 'INACTIVE';
        
        // Get lead name
        let leadName = item.userId?.fullName || "N/A";
        if (!leadName || leadName === "N/A") {
          if (item.members && item.members.length > 0) {
            const headMember = item.members.find(m => 
              m.relationship && m.relationship.toLowerCase().includes('head') || 
              m.relationship && m.relationship.toLowerCase().includes('lead')
            );
            if (headMember && headMember.userId?.fullName) {
              leadName = headMember.userId.fullName;
            } else if (item.members[0].userId?.fullName) {
              leadName = item.members[0].userId.fullName;
            }
          }
        }
        
        // Household number
        let householdNumber = item.householdCode || item.householdNumber || 
                             `HH-${item._id ? item._id.substring(0, 6) : '000000'}`;
        
        // Contact number
        const contactNumber = item.userId?.contactNumber || item.emergencyContact || 'N/A';
        
        // Total members
        const totalMembers = item.totalMembers || (item.members ? item.members.length : 0);
        
        // Create initials for avatar
        const initials = leadName.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2) || 'HH';
        
        return `
          <div class="modern-popup">
            <div class="popup-header">
              <div class="popup-title">
                <i class="fas fa-home"></i>
                Household Details
              </div>
              <div class="popup-status" style="background: ${statusColor};">${statusText}</div>
            </div>
            <div class="popup-content">
              <!-- Lead Information -->
              <div class="lead-info-section">
                <div class="lead-avatar">
                  ${initials}
                </div>
                <div class="lead-name">
                  ${leadName}
                </div>
                <div class="household-badge">
                  <i class="fas fa-hashtag"></i> ${householdNumber}
                </div>
              </div>
              
              <!-- Quick Stats -->
              <div class="quick-stats">
                <div class="quick-stat">
                  <div class="quick-stat-icon">
                    <i class="fas fa-users"></i>
                  </div>
                  <div class="quick-stat-value">${totalMembers}</div>
                  <div class="quick-stat-label">Members</div>
                </div>
                <div class="quick-stat">
                  <div class="quick-stat-icon">
                    <i class="fas fa-phone"></i>
                  </div>
                  <div class="quick-stat-value" style="font-size: 10px;">${contactNumber.substring(0, 8)}${contactNumber.length > 8 ? '...' : ''}</div>
                  <div class="quick-stat-label">Contact</div>
                </div>
                <div class="quick-stat">
                  <div class="quick-stat-icon">
                    <i class="fas fa-check-circle" style="color: ${statusColor};"></i>
                  </div>
                  <div class="quick-stat-value" style="color: ${statusColor};">${isActive ? 'Yes' : 'No'}</div>
                  <div class="quick-stat-label">Active</div>
                </div>
              </div>
              
              <!-- Coordinates with Zoom Info -->
              <div class="coordinates-section">
                <div class="coordinates-grid">
                  <div class="coordinate-item">
                    <div class="coordinate-label">Latitude</div>
                    <div class="coordinate-value">${lat.toFixed(6)}</div>
                  </div>
                  <div class="coordinate-item">
                    <div class="coordinate-label">Longitude</div>
                    <div class="coordinate-value">${lng.toFixed(6)}</div>
                  </div>
                </div>
                
                <!-- LAST ZOOM LEVEL DISPLAY -->
                <div class="zoom-info">
                  <div class="zoom-label">
                    <i class="fas fa-search-plus"></i>
                    <span>Last Zoom Before Click</span>
                  </div>
                  <div class="zoom-value">${lastZoomBeforeClick}</div>
                </div>
              </div>
              
              <!-- Address if available -->
              ${item.userId?.address ? `
              <div class="quick-stat" style="text-align: left; padding: 10px; margin: 12px 0;">
                <div class="quick-stat-icon" style="margin: 0 0 6px 0;">
                  <i class="fas fa-map-marker-alt"></i>
                </div>
                <div style="font-size: 10px; color: #6b7280; margin-bottom: 4px;">Address</div>
                <div style="font-size: 11px; color: #111827; line-height: 1.4;">${item.userId.address.substring(0, 50)}${item.userId.address.length > 50 ? '...' : ''}</div>
              </div>
              ` : ''}
              
              <!-- Action Buttons -->
              <div class="action-buttons">
                <button class="action-btn" onclick="map.setView([${lat}, ${lng}], 18, { animate: true, duration: 1 });">
                  <i class="fas fa-crosshairs"></i>
                  <span>Zoom In</span>
                </button>
                <button class="action-btn action-btn-secondary" onclick="map.setView([${lat}, ${lng}], ${lastZoomBeforeClick}, { animate: true, duration: 1 });">
                  <i class="fas fa-undo"></i>
                  <span>Last Zoom (${lastZoomBeforeClick})</span>
                </button>
              </div>
              
              <!-- Last Update Time -->
              <div class="last-update">
                <i class="far fa-clock"></i>
                <span>Updated: ${formatDate(item.updatedAt || item.createdAt)}</span>
              </div>
            </div>
          </div>
        `;
      }
      
      // Update map view
      function updateMapView(data) {
        currentView = data.view || "both";
        const focusOnId = data.focusOn || lastFocusedHouseholdId;
        iconType = data.iconType || "professional";
        
        // Clear all layers
        municipalityLayerGroup.clearLayers();
        evacuationLayerGroup.clearLayers();
        householdLayerGroup.clearLayers();
        
        // Show loading
        showLoading();
        
        // Add layers based on visibility with slight delay for smooth transition
        setTimeout(() => {
          if (data.municipalitiesVisible && data.municipalities && data.municipalities.length > 0) {
            addMunicipalityMarkers(data.municipalities);
            municipalityLayerGroup.addTo(map);
          }
          
          if (data.evacuationsVisible && data.evacuations && data.evacuations.length > 0) {
            addEvacuationMarkers(data.evacuations);
            evacuationLayerGroup.addTo(map);
          }
          
          if (data.householdVisible && data.household && data.household.length > 0) {
            addHouseholdMarkers(data.household, focusOnId);
            householdLayerGroup.addTo(map);
          }
          
          // Fit bounds to show all markers
          fitMapToBounds(data);
          
          // Update legend
          updateLegend(data);
          
          // Hide loading
          hideLoading();
        }, 300);
      }
      
      // Fit map to bounds
      function fitMapToBounds(data) {
        let allBounds = [];
        
        if (data.municipalitiesVisible && data.municipalities) {
          data.municipalities.forEach(item => {
            if (item.coordinates?.latitude && item.coordinates?.longitude) {
              allBounds.push([item.coordinates.latitude, item.coordinates.longitude]);
            }
          });
        }
        
        if (data.evacuationsVisible && data.evacuations) {
          data.evacuations.forEach(item => {
            if (item.location?.latitude && item.location?.longitude) {
              allBounds.push([item.location.latitude, item.location.longitude]);
            }
          });
        }
        
        if (data.householdVisible && data.household) {
          data.household.forEach(item => {
            if (item.location?.latitude && item.location?.longitude) {
              allBounds.push([item.location.latitude, item.location.longitude]);
            }
          });
        }
        
        if (allBounds.length > 0) {
          const bounds = L.latLngBounds(allBounds);
          
          if (bounds.isValid()) {
            map.fitBounds(bounds, { 
              padding: [50, 50],
              maxZoom: 12,
              animate: true
            });
          } else {
            const firstPoint = allBounds[0];
            map.setView(firstPoint, 12);
          }
        } else if (data.household && data.household.length > 0 && data.household[0].location) {
          const firstHousehold = data.household[0];
          map.setView([firstHousehold.location.latitude, firstHousehold.location.longitude], 13);
        }
      }
      
      // Update legend
      function updateLegend(data) {
        const legend = document.getElementById('legend');
        const legendItems = document.getElementById('legend-items');
        
        if (!legend || !legendItems) return;
        
        let legendContent = '';
        let hasContent = false;
        
        if (data.municipalitiesVisible && data.municipalities && data.municipalities.length > 0) {
          legendContent += `
            <div class="legend-item">
              <div class="legend-icon" style="background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);">
                <i class="fas fa-city"></i>
              </div>
              <div class="legend-text">Municipalities</div>
              <div class="legend-count">${data.municipalities.length}</div>
            </div>
          `;
          hasContent = true;
        }
        
        if (data.evacuationsVisible && data.evacuations && data.evacuations.length > 0) {
          const fullCount = data.evacuations.filter(e => e.status?.toLowerCase() === 'full').length;
          const highCount = data.evacuations.filter(e => e.status?.toLowerCase() === 'high').length;
          const availableCount = data.evacuations.filter(e => e.status?.toLowerCase() === 'available').length;
          const unknownCount = data.evacuations.filter(e => !e.status || e.status.toLowerCase() === 'unknown').length;
          
          if (availableCount > 0) {
            legendContent += `
              <div class="legend-item">
                <div class="legend-icon" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                  <i class="fas fa-first-aid"></i>
                </div>
                <div class="legend-text">Available</div>
                <div class="legend-count">${availableCount}</div>
              </div>
            `;
          }
          
          if (highCount > 0) {
            legendContent += `
              <div class="legend-item">
                <div class="legend-icon" style="background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);">
                  <i class="fas fa-first-aid"></i>
                </div>
                <div class="legend-text">High Occupancy</div>
                <div class="legend-count">${highCount}</div>
              </div>
            `;
          }
          
          if (fullCount > 0) {
            legendContent += `
              <div class="legend-item">
                <div class="legend-icon" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);">
                  <i class="fas fa-first-aid"></i>
                </div>
                <div class="legend-text">Full</div>
                <div class="legend-count">${fullCount}</div>
              </div>
            `;
          }
          
          if (unknownCount > 0) {
            legendContent += `
              <div class="legend-item">
                <div class="legend-icon" style="background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);">
                  <i class="fas fa-first-aid"></i>
                </div>
                <div class="legend-text">Unknown</div>
                <div class="legend-count">${unknownCount}</div>
              </div>
            `;
          }
          
          hasContent = true;
        }
        
        if (data.householdVisible && data.household && data.household.length > 0) {
          const activeCount = data.household.filter(h => h.isActive).length;
          const inactiveCount = data.household.filter(h => !h.isActive).length;
          
          if (activeCount > 0) {
            legendContent += `
              <div class="legend-item">
                <div class="legend-icon" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);">
                  <i class="fas fa-home"></i>
                </div>
                <div class="legend-text">Active Households</div>
                <div class="legend-count">${activeCount}</div>
              </div>
            `;
          }
          
          if (inactiveCount > 0) {
            legendContent += `
              <div class="legend-item">
                <div class="legend-icon" style="background: linear-gradient(135deg, #a78bfa 0%, #8b5cf6 100%);">
                  <i class="fas fa-home"></i>
                </div>
                <div class="legend-text">Inactive Households</div>
                <div class="legend-count">${inactiveCount}</div>
              </div>
            `;
          }
          
          hasContent = true;
        }
        
        legendItems.innerHTML = legendContent;
        legend.style.display = hasContent ? 'block' : 'none';
      }
      
      // Show loading overlay
      function showLoading() {
        let loadingOverlay = document.getElementById('loading-overlay');
        if (!loadingOverlay) {
          loadingOverlay = document.createElement('div');
          loadingOverlay.id = 'loading-overlay';
          loadingOverlay.className = 'loading-overlay';
          loadingOverlay.innerHTML = `
            <div class="loading-spinner"></div>
            <div style="color: #4b5563; font-size: 13px; font-weight: 500;">Loading map...</div>
          `;
          document.body.appendChild(loadingOverlay);
        }
      }
      
      // Hide loading overlay
      function hideLoading() {
        const loadingOverlay = document.getElementById('loading-overlay');
        if (loadingOverlay) {
          loadingOverlay.style.opacity = '0';
          setTimeout(() => {
            if (loadingOverlay.parentNode) {
              loadingOverlay.parentNode.removeChild(loadingOverlay);
            }
          }, 300);
        }
      }
      
      // Initialize the map
      document.addEventListener('DOMContentLoaded', function() {
        // Default coordinates
        map = L.map('map').setView([37.4219983, -122.084], 13);
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          maxZoom: 19,
          attribution: ' OpenStreetMap contributors',
          detectRetina: true
        }).addTo(map);
        
        // Track zoom changes
        map.on('zoomend', function() {
          lastZoomLevel = map.getZoom();
          console.log('Current zoom level:', lastZoomLevel);
        });
        
        // Add scale control
        L.control.scale({ imperial: false }).addTo(map);
        
        // Add layer control
        const baseLayers = {
          "OpenStreetMap": L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png')
        };
        
        const overlays = {
          "<i class='fas fa-city'></i> Municipalities": municipalityLayerGroup,
          "<i class='fas fa-first-aid'></i> Evacuation Centers": evacuationLayerGroup,
          "<i class='fas fa-home'></i> Households": householdLayerGroup
        };
        
        L.control.layers(baseLayers, overlays, {
          collapsed: true,
          position: 'topright'
        }).addTo(map);
        
        // Initial legend
        updateLegend({
          municipalities: [],
          evacuations: [],
          household: [],
          municipalitiesVisible: false,
          evacuationsVisible: false,
          householdVisible: false
        });
      });
      
      // Listen for messages from React Native
      document.addEventListener("message", function(event) {
        try {
          const data = JSON.parse(event.data);
          updateMapView(data);
        } catch (error) {
          console.error("Error parsing data:", error);
          hideLoading();
        }
      });
      
      // Also handle window message events (for web debugging)
      window.addEventListener("message", function(event) {
        try {
          const data = JSON.parse(event.data);
          updateMapView(data);
        } catch (error) {
          console.error("Error parsing data:", error);
          hideLoading();
        }
      });
      
      // Error handling
      window.onerror = function(message, source, lineno, colno, error) {
        console.error("Map error:", { message, source, lineno, colno, error });
        hideLoading();
        return false;
      };
    </script>
  </body>
</html>